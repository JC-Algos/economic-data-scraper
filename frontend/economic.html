<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JC Algos 中、美經濟數據分析</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: none; /* Hidden by default, toggled by JS */
        }

        .main-container {
            display: none; /* Hidden by default until auth check passes */
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .data-table {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            margin-bottom: 0;
        }

        table th {
            background-color: #667eea;
            color: white;
            text-align: center;
            vertical-align: middle;
            padding: 12px;
            font-weight: 600;
        }

        table td {
            text-align: center;
            vertical-align: middle;
            padding: 10px;
        }

        .employment-row { background-color: #FFFFE0; }
        .inflation-row { background-color: #E6E6FA; }
        .other-row { background-color: #E6F3FF; }

        .china-row-1 { background-color: #FFFFE0; }
        .china-row-2 { background-color: #E6E6FA; }
        .china-row-3 { background-color: #E6F3FF; }
        .china-row-4 { background-color: #FFFFFF; }

        .better { color: #28a745; font-weight: bold; }
        .worse { color: #dc3545; font-weight: bold; }
        .equal { color: #6c757d; }

        /* Row-level styling for better/worse forecast comparison */
        tr.better-row {
            font-weight: bold !important;
            background-color: #d4edda !important;
            color: #155724 !important;
        }
        tr.better-row td {
            font-weight: bold !important;
            background-color: #d4edda !important;
            color: #155724 !important;
        }

        tr.worse-row {
            font-weight: bold !important;
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }
        tr.worse-row td {
            font-weight: bold !important;
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            min-height: 400px;
        }

        .indicator-btn {
            margin: 5px 0;
            width: 100%;
            text-align: left;
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .alert-custom {
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .data-table { overflow-x: scroll; }
            table { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <h3 class="text-center mb-4">登入系統</h3>
        <form id="loginForm">
            <div class="mb-3">
                <label for="email" class="form-label">電子郵件</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">密碼</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">登入</button>
            <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>
        </form>
    </div>

    <div class="container-fluid main-container" id="mainContainer">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">JC Algos 中、美經濟數據分析</h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-light" onclick="goToHomepage()">
                        <i class="bi bi-house-door"></i> 回首頁
                    </button>
                    <button class="btn btn-light" onclick="logout()">登出</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="sidebar">
                    <h5 class="mb-3">選擇國家</h5>
                    <select class="form-select mb-3" id="countrySelect" onchange="changeCountry()">
                        <option value="US">美國 (US)</option>
                        <option value="China">中國 (China)</option>
                    </select>

                    <button class="btn btn-primary w-100 mb-3" onclick="fetchData()">
                        <span id="fetchBtnText">爬取並分析數據</span>
                        <span class="spinner-border spinner-border-sm ms-2" style="display: none;" id="fetchSpinner"></span>
                    </button>

                    <hr>

                    <h5 class="mb-3">選擇指標</h5>
                    <div id="indicatorButtons"></div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="data-table" id="dataTableContainer" style="display: none;">
                    <h4 class="mb-3">數據總結</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="dataTable">
                            <thead>
                                <tr>
                                    <th>指標</th>
                                    <th>數據更新</th>
                                    <th>與預測比較</th>
                                    <th>預測</th>
                                    <th>本月</th>
                                    <th>1月前</th>
                                    <th>2月前</th>
                                    <th>3月前</th>
                                    <th>4月前</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-success mt-3" onclick="downloadCSV()">
                        下載數據為CSV
                    </button>
                </div>

                <div class="chart-container" id="chartContainer" style="display: none;">
                    <h4 id="chartTitle" class="mb-3">選擇指標以查看圖表</h4>
                    <canvas id="dataChart"></canvas>
                </div>

                <div class="alert alert-warning alert-custom" role="alert">
                    <strong>注意：</strong>此分析器僅用於教育目的、不保證資料準確性。
                </div>

                <div class="alert alert-info alert-custom" role="alert">
                    <strong>注意：</strong>現階段, 美國通脹數據如高於預期是不利經濟及股市, 中國通脹數據如果低於預期是不利於經濟及股市。
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==================== CONFIGURATION ====================
        // Backend API Configuration
        // ⚠️ CHANGE THIS to your backend API URL
        // If backend is on same server: use "" (empty string)
        // If backend is on another server: use full URL e.g. "https://api.jc-algos.com/api"
        const BACKEND_API_URL = "http://72.62.251.37:5005";  
        const USE_SAMPLE_DATA = false; 

        // ==================== APPLICATION STATE ====================
        let currentCountry = "US";
        let currentData = null;
        let currentChart = null;

        // ==================== SUPABASE AUTH LOGIC ====================
        const loginContainer = document.getElementById('loginContainer');
        const mainContainer = document.getElementById('mainContainer');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        // 1. Check Auth State on Load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check if SupabaseAuth is available (loaded from supabase-config.js)
                if (typeof SupabaseAuth === 'undefined') {
                    console.error('SupabaseAuth not loaded! Check supabase-config.js path.');
                    return;
                }

                // Check session
                const isAuth = await SupabaseAuth.isAuthenticated();

                if (isAuth) {
                    showDashboard();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error("Auth Check Error:", error);
                showLogin();
            }
        });

        // 2. Handle Login Submission
        if (loginForm) {
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                
                // Disable button and show loading state
                const btn = loginForm.querySelector('button');
                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = '登入中...';
                loginError.style.display = 'none';

                try {
                    const { data, error } = await SupabaseAuth.signIn(email, password);
                    
                    if (error) {
                        throw error;
                    }

                    // Login successful
                    showDashboard();
                    
                } catch (err) {
                    loginError.textContent = err.message || '登入失敗，請檢查帳號密碼';
                    loginError.style.display = 'block';
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            });
        }

        // 3. Logout Function
        async function logout() {
            try {
                await SupabaseAuth.signOut();
                window.location.reload(); // Reload page to show login form
            } catch (error) {
                console.error('Logout error:', error);
                alert('登出時發生錯誤');
            }
        }

        // Helper: Show Dashboard
        function showDashboard() {
            loginContainer.style.display = 'none';
            mainContainer.style.display = 'block';
        }

        // Helper: Show Login
        function showLogin() {
            loginContainer.style.display = 'block';
            mainContainer.style.display = 'none';
        }

        // ==================== APP LOGIC ====================

        function goToHomepage() {
            window.location.href = 'index.html';
        }

        function changeCountry() {
            currentCountry = document.getElementById('countrySelect').value;
            document.getElementById('dataTableContainer').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('indicatorButtons').innerHTML = '';
        }

        // Fetch data function
        async function fetchData() {
            const fetchBtn = document.querySelector('button[onclick="fetchData()"]');
            const fetchBtnText = document.getElementById('fetchBtnText');
            const fetchSpinner = document.getElementById('fetchSpinner');

            fetchBtn.disabled = true;
            fetchBtnText.textContent = '正在爬取數據...';
            fetchSpinner.style.display = 'inline-block';

            try {
                let data;

                // Check if we should use sample data or real backend
                if (USE_SAMPLE_DATA) {
                    console.log('Using sample data (USE_SAMPLE_DATA is true)');
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate delay
                    data = getSampleData(currentCountry);
                } else {
                    // Fetch from real backend API
                    const apiUrl = `${BACKEND_API_URL}/scrape?country=${currentCountry}`;
                    console.log('Fetching data from:', apiUrl);

                    const response = await fetch(apiUrl);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('API Response:', result);

                    if (!result.success) {
                        throw new Error(result.error || 'Failed to fetch data');
                    }

                    data = result.data;
                }

                if (!data || data.length === 0) {
                    alert('沒有爬取到任何數據。請稍後再試。');
                    return;
                }

                currentData = data;
                displayData(data);
                createIndicatorButtons(data);

                document.getElementById('dataTableContainer').style.display = 'block';
                console.log(`Successfully loaded ${data.length} indicators`);

            } catch (error) {
                console.error('Error:', error);
                alert('數據爬取失敗: ' + error.message + '\n\n請確保後端API正在運行，或設置 USE_SAMPLE_DATA = true 來使用示例數據。');

                // Fallback to sample data if real backend fails
                if (!USE_SAMPLE_DATA) {
                    console.log('Using sample data as fallback due to error');
                    const data = getSampleData(currentCountry);
                    currentData = data;
                    displayData(data);
                    createIndicatorButtons(data);
                    document.getElementById('dataTableContainer').style.display = 'block';
                }
            } finally {
                fetchBtn.disabled = false;
                fetchBtnText.textContent = '爬取並分析數據';
                fetchSpinner.style.display = 'none';
            }
        }

        function getSampleData(country) {
            // Sample data structure - replace with actual API data
            if (country === "US") {
                return [
                    {
                        indicator: "United States Unemployment Rate",
                        date: "Dec 06, 2024",
                        vsForcast: "持平",
                        forecast: "4.2%",
                        current: "4.2%",
                        month1: "4.1%",
                        month2: "4.1%",
                        month3: "4.2%",
                        month4: "3.9%",
                        category: "employment",
                        historicalData: [
                            {date: "2024-12-06", actual: 4.2, forecast: 4.2},
                            {date: "2024-11-01", actual: 4.1, forecast: 4.1},
                            {date: "2024-10-04", actual: 4.1, forecast: 4.2},
                            {date: "2024-09-06", actual: 4.2, forecast: 4.2},
                            {date: "2024-08-02", actual: 3.9, forecast: 4.1}
                        ]
                    },
                    {
                        indicator: "United States Nonfarm Payrolls",
                        date: "Dec 06, 2024",
                        vsForcast: "較好",
                        forecast: "200K",
                        current: "227K",
                        month1: "36K",
                        month2: "223K",
                        month3: "254K",
                        month4: "159K",
                        category: "employment",
                        historicalData: [
                            {date: "2024-12-06", actual: 227, forecast: 200},
                            {date: "2024-11-01", actual: 36, forecast: 113},
                            {date: "2024-10-04", actual: 223, forecast: 140},
                            {date: "2024-09-06", actual: 254, forecast: 140},
                            {date: "2024-08-02", actual: 159, forecast: 175}
                        ]
                    },
                    {
                        indicator: "United States Consumer Price Index (CPI) YoY",
                        date: "Dec 11, 2024",
                        vsForcast: "較差",
                        forecast: "2.7%",
                        current: "2.7%",
                        month1: "2.6%",
                        month2: "2.4%",
                        month3: "2.5%",
                        month4: "2.9%",
                        category: "inflation",
                        historicalData: [
                            {date: "2024-12-11", actual: 2.7, forecast: 2.7},
                            {date: "2024-11-13", actual: 2.6, forecast: 2.6},
                            {date: "2024-10-10", actual: 2.4, forecast: 2.3},
                            {date: "2024-09-11", actual: 2.5, forecast: 2.5},
                            {date: "2024-08-14", actual: 2.9, forecast: 3.0}
                        ]
                    }
                ];
            } else {
                return [
                    {
                        indicator: "China Exports YoY",
                        date: "Dec 10, 2024",
                        vsForcast: "較好",
                        forecast: "8.5%",
                        current: "6.7%",
                        month1: "12.7%",
                        month2: "12.7%",
                        month3: "8.7%",
                        month4: "8.7%",
                        category: "trade",
                        historicalData: [
                            {date: "2024-12-10", actual: 6.7, forecast: 8.5},
                            {date: "2024-11-07", actual: 12.7, forecast: 5.2},
                            {date: "2024-10-14", actual: 12.7, forecast: 6.0},
                            {date: "2024-09-10", actual: 8.7, forecast: 6.5},
                            {date: "2024-08-07", actual: 8.7, forecast: 7.0}
                        ]
                    },
                    {
                        indicator: "China Consumer Price Index (CPI) YoY",
                        date: "Dec 09, 2024",
                        vsForcast: "持平",
                        forecast: "0.5%",
                        current: "0.5%",
                        month1: "0.2%",
                        month2: "0.4%",
                        month3: "0.4%",
                        month4: "0.6%",
                        category: "inflation",
                        historicalData: [
                            {date: "2024-12-09", actual: 0.5, forecast: 0.5},
                            {date: "2024-11-09", actual: 0.2, forecast: 0.3},
                            {date: "2024-10-15", actual: 0.4, forecast: 0.6},
                            {date: "2024-09-09", actual: 0.4, forecast: 0.5},
                            {date: "2024-08-09", actual: 0.6, forecast: 0.4}
                        ]
                    }
                ];
            }
        }

        function displayData(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');

                // Determine row class based on category
                let rowClass = '';
                if (currentCountry === "US") {
                    if (index < 5) rowClass = 'employment-row';
                    else if (index < 13) rowClass = 'inflation-row';
                    else rowClass = 'other-row';
                } else {
                    if (index < 6) rowClass = 'china-row-1';
                    else if (index < 9) rowClass = 'china-row-2';
                    else if (index < 14) rowClass = 'china-row-3';
                    else rowClass = 'china-row-4';
                }

                // Add better/worse row styling
                if (item.vsForcast === '較好') {
                    rowClass += ' better-row';
                } else if (item.vsForcast === '較差') {
                    rowClass += ' worse-row';
                }

                row.className = rowClass;

                // Determine comparison class for the vsForcast cell
                let compClass = '';
                if (item.vsForcast === '較好') compClass = 'better';
                else if (item.vsForcast === '較差') compClass = 'worse';
                else compClass = 'equal';

                row.innerHTML = `
                    <td>${item.indicator}</td>
                    <td>${item.date}</td>
                    <td class="${compClass}">${item.vsForcast}</td>
                    <td>${item.forecast}</td>
                    <td>${item.current}</td>
                    <td>${item.month1}</td>
                    <td>${item.month2}</td>
                    <td>${item.month3}</td>
                    <td>${item.month4}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function createIndicatorButtons(data) {
            const container = document.getElementById('indicatorButtons');
            container.innerHTML = '';

            data.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary indicator-btn';
                btn.textContent = item.indicator;
                btn.onclick = () => showChart(item);
                container.appendChild(btn);
            });
        }

        function showChart(item) {
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('chartTitle').textContent = item.indicator;

            // Check if historical data exists
            if (!item.historicalData || item.historicalData.length === 0) {
                const ctx = document.getElementById('dataChart').getContext('2d');
                if (currentChart) {
                    currentChart.destroy();
                }
                alert('此指標沒有足夠的歷史數據來顯示圖表');
                return;
            }

            // Destroy previous chart if exists
            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = document.getElementById('dataChart').getContext('2d');

            // Format dates and prepare data (reverse to show latest on right)
            const reversedData = [...item.historicalData].reverse();
            const dates = reversedData.map(d => {
                // Format date from ISO string to readable format
                const date = new Date(d.date);
                return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short', day: 'numeric' });
            });
            const actuals = reversedData.map(d => d.actual);
            const forecasts = reversedData.map(d => d.forecast);

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '實際值',
                            data: actuals,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '預測值',
                            data: forecasts,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderDash: [5, 5],
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // Scroll to chart
            document.getElementById('chartContainer').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function downloadCSV() {
            if (!currentData) return;

            let csv = '指標,數據更新,與預測比較,預測,本月,1月前,2月前,3月前,4月前\n';

            currentData.forEach(item => {
                csv += `"${item.indicator}","${item.date}","${item.vsForcast}","${item.forecast}","${item.current}","${item.month1}","${item.month2}","${item.month3}","${item.month4}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `economic_data_${currentCountry}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>